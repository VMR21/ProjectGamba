<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Slot Picker</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg1:#0c0f16; --card:#1b2236; --chip:#4c52ff; --text:#e8ecff; --muted:#93a1bd;
    --btn:#3b42ff; --btn-hover:#2b31d8; --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:24px; font-family:Nunito,system-ui,Arial; color:var(--text);
    background: radial-gradient(1200px 800px at 15% 0%, #1a1b36 0%, #0c0f16 45%) fixed,
                radial-gradient(1000px 800px at 90% 30%, #122339 0%, #0c0f16 60%) fixed,
                var(--bg1);
  }
  .app{max-width:1150px; margin:0 auto; display:grid; grid-template-columns: 1.2fr 1fr; gap:24px}
  .panel{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); padding:18px; border-radius:20px; box-shadow:var(--shadow)}
  .panel h2{margin:0 0 12px; font-size:26px}
  .row{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 6px}
  .controls{display:flex; gap:10px; flex-wrap:wrap}
  .chip{
    background:transparent; color:var(--text); padding:10px 14px; border-radius:999px;
    border:1px solid rgba(255,255,255,.18); font-weight:800; cursor:pointer; user-select:none;
  }
  .chip.active{ background:var(--chip); border-color:transparent }
  .btn{ background:var(--btn); color:#fff; border:0; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer }
  .btn:hover{ background:var(--btn-hover) }
  .right{display:grid; gap:16px; grid-template-rows:auto 1fr auto}
  .card-wrap{display:grid; place-items:center; height:420px}
  .card{ width:360px; height:360px; perspective:1200px; filter: drop-shadow(0 20px 40px rgba(0,0,0,.45)); }
  .card-inner{
    position:relative; width:100%; height:100%; transform-style:preserve-3d;
    transition:transform .7s cubic-bezier(.2,.7,.2,1); border-radius:var(--radius); overflow:hidden;
    border:1px solid rgba(255,255,255,.08); background:var(--card);
  }
  .card.flipped .card-inner{ transform:rotateY(180deg) }

  /* 3D faces (fix mirroring + Safari glitch) */
  .face{
    position:absolute; inset:0; padding:12px; display:grid; place-items:center;
    backface-visibility:hidden; -webkit-backface-visibility:hidden;
    transform:rotateY(0);
  }
  .front{ background:#151b2b; }
  .back{ background:#0f1322; transform:rotateY(180deg); }

  /* FRONT starts with placeholder, then shows picked image */
  #slotFrontPlaceholder{ color:#b8c4ff; letter-spacing:1px; font-weight:800 }
  #slotImgFront{
    display:none;
    max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain;
    border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.35); display:block;
  }

  /* BACK shows same image after flip — no crop */
  .back img{
    max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain;
    border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.35); display:block;
  }

  .meta{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .meta .title{font-size:22px; font-weight:800}
  .meta .sub{color:var(--muted); font-weight:700}
  .foot{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
  .pill{padding:8px 10px; border-radius:999px; border:1px dashed rgba(255,255,255,.18); color:var(--muted)}
</style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <h2>Providers</h2>
      <div class="controls">
        <button class="btn" id="selectAll">Select All</button>
        <button class="btn" id="deselectAll">Deselect All</button>
        <span class="pill" id="status">Loading /slots.csv…</span>
      </div>
      <div id="providers" class="row"></div>
      <small id="counts"></small>
    </div>

    <div class="right">
      <div class="panel card-wrap">
        <div class="card" id="card">
          <div class="card-inner">
            <!-- FRONT shows placeholder or the chosen slot -->
            <div class="face front">
              <div id="slotFrontPlaceholder">Pick A Slot</div>
              <img id="slotImgFront" alt="">
            </div>
            <!-- BACK shows the chosen slot after flip -->
            <div class="face back"><img id="slotImg" alt=""></div>
          </div>
        </div>
      </div>

      <div class="panel meta">
        <div>
          <div class="title" id="slotName">—</div>
          <div class="sub" id="slotProvider">—</div>
        </div>
        <button class="btn" id="pickBtn">Pick A Slot</button>
      </div>

      <div class="foot"><small class="pill" id="filterSummary">0 providers selected</small></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    let allSlots = [];           // {name, provider, image}
    let providers = new Set();   // all provider names
    let selected = new Set();    // selected providers

    const els = {
      providers: document.getElementById('providers'),
      selectAll: document.getElementById('selectAll'),
      deselectAll: document.getElementById('deselectAll'),
      filterSummary: document.getElementById('filterSummary'),
      counts: document.getElementById('counts'),
      pickBtn: document.getElementById('pickBtn'),
      card: document.getElementById('card'),
      slotImg: document.getElementById('slotImg'),
      slotImgFront: document.getElementById('slotImgFront'),
      slotFrontPlaceholder: document.getElementById('slotFrontPlaceholder'),
      slotName: document.getElementById('slotName'),
      slotProvider: document.getElementById('slotProvider'),
      status: document.getElementById('status'),
    };

    // Upscale imgix-style URLs so images are sharp
    function upscale(url){
      if(!url) return url;
      try{
        const u = new URL(url, location.href);
        if(u.hostname.includes('imgix')){
          const p = u.searchParams;
          if(p.has('w')) p.set('w','720');
          if(p.has('h')) p.set('h','944'); // similar ratio to 180x236, but bigger
          return u.toString();
        }
      }catch(e){}
      return url;
    }

    const byProvider = () => allSlots.filter(s => selected.size ? selected.has(s.provider) : true);

    function renderProviders() {
      els.providers.innerHTML = '';
      [...providers].sort((a,b)=>a.localeCompare(b)).forEach(p => {
        const chip = document.createElement('button');
        chip.className = 'chip' + (selected.has(p) ? ' active' : '');
        chip.textContent = p;
        chip.onclick = () => { selected.has(p) ? selected.delete(p) : selected.add(p); renderProviders(); refreshCounts(); };
        els.providers.appendChild(chip);
      });
      refreshCounts();
    }

    function refreshCounts() {
      els.filterSummary.textContent = `${selected.size} provider${selected.size!==1?'s':''} selected`;
      const visible = byProvider().length;
      els.counts.textContent = allSlots.length
        ? `${visible.toLocaleString()} of ${allSlots.length.toLocaleString()} slots match`
        : '';
    }

    function flipToBack(){ els.card.classList.add('flipped'); }
    function flipToFront(){ els.card.classList.remove('flipped'); }

    function showImages(url){
      // Hide placeholder, show images on both faces (prevents mirrored front during flip)
      els.slotFrontPlaceholder.style.display = 'none';
      els.slotImgFront.style.display = 'block';
      els.slotImgFront.src = url;   // front
      els.slotImg.src = url;        // back
    }

    function pickRandom() {
      const pool = byProvider();
      if (!pool.length) { alert('No slots in current filter. Select some providers.'); return; }
      const choice = pool[Math.floor(Math.random() * pool.length)];
      const hi = upscale(choice.image);

      const pre = new Image();
      pre.onload = () => {
        showImages(hi);                           // set both faces with the same orientation
        els.slotImg.alt = choice.name;
        els.slotName.textContent = choice.name;
        els.slotProvider.textContent = choice.provider;
        flipToBack();
      };
      pre.onerror = () => {
        els.slotImgFront.removeAttribute('src');
        els.slotImg.removeAttribute('src');
        els.slotName.textContent = choice.name;
        els.slotProvider.textContent = `${choice.provider} (image unavailable)`;
        flipToBack();
      };

      // Do a front flip first if we're already showing the back, so you don't see a mirrored frame
      if (els.card.classList.contains('flipped')) {
        flipToFront();
        setTimeout(() => pre.src = hi, 350);
      } else {
        setTimeout(() => pre.src = hi, 60);
      }
    }

    // Load /slots.csv on page load
    async function loadCSV(){
      try{
        const res = await fetch('/slots.csv', {cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true, transformHeader:h=>h.trim().toLowerCase()});
        allSlots = parsed.data.map(r => ({
          name: (r.name || r.slot || r.title || '').trim(),
          provider: (r.provider || r.vendor || r.studio || '').trim(),
          image: (r.image || r.img || r.thumbnail || '').trim()
        })).filter(x => x.name && x.provider && x.image);

        providers = new Set(allSlots.map(s => s.provider));
        selected = new Set(providers); // preselect all
        renderProviders();
        els.status.textContent = `Loaded ${allSlots.length} slots`;
      }catch(err){
        els.status.textContent = `Failed to load /slots.csv (${err.message})`;
      }
    }

    els.selectAll.onclick = () => { selected = new Set(providers); renderProviders(); };
    els.deselectAll.onclick = () => { selected = new Set(); renderProviders(); };
    els.pickBtn.onclick = pickRandom;
    window.addEventListener('keydown', e => { if(e.code==='Space'){ e.preventDefault(); pickRandom(); } });

    loadCSV();
  </script>
</body>
</html>
